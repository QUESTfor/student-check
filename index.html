<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿæº–å‚™ç‹€æ…‹ç¢ºèªç³»çµ±</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; background-color: #f0f2f5; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #1a73e8; }
        
        /* ç™»å…¥å€å¡Š */
        .login-box { text-align: center; margin-bottom: 30px; padding: 20px; border: 2px dashed #ccc; border-radius: 8px; }
        input[type="text"] { padding: 10px; width: 250px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        
        /* ç‹€æ…‹å¡ç‰‡ç¶²æ ¼ */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .card { border: 1px solid #eee; padding: 15px; border-radius: 8px; text-align: center; background: #fff; transition: transform 0.2s; }
        .card.active { border: 2px solid #1a73e8; box-shadow: 0 2px 8px rgba(26,115,232,0.2); }
        .status-tag { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 14px; margin-top: 10px; }
        .sent { background: #e6f4ea; color: #1e8e3e; font-weight: bold; }
        .waiting { background: #f1f3f4; color: #70757a; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { cursor: pointer; padding: 8px 16px; border: none; border-radius: 4px; font-weight: bold; margin: 5px; transition: 0.3s; }
        .btn-send { background-color: #1e8e3e; color: white; }
        .btn-send:hover { background-color: #15652f; }
        .btn-cancel { background-color: #d93025; color: white; }
        .btn-cancel:hover { background-color: #a50e0e; }
        .btn-join { background-color: #1a73e8; color: white; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“ å­¸ç”Ÿæº–å‚™ç‹€æ…‹ (å³æ™‚åŒæ­¥)</h2>

    <div id="login-section" class="login-box">
        <input type="text" id="student-name" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å..." maxlength="10">
        <button onclick="joinClass()" class="btn btn-join">é€²å…¥æ•™å®¤</button>
        <p id="room-status" style="font-size: 14px; color: #666;"></p>
    </div>

    <div id="student-grid" class="grid">
        </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // æ‚¨çš„ Firebase é…ç½® (å·²å¥—ç”¨æ‚¨æä¾›çš„è³‡è¨Š)
    const firebaseConfig = {
        apiKey: "AIzaSyAna6t9OKbPQ96tM6GMsIs0-pwvDOJraFc",
        authDomain: "student-check-system-39d00.firebaseapp.com",
        databaseURL: "https://student-check-system-39d00-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "student-check-system-39d00",
        storageBucket: "student-check-system-39d00.firebasestorage.app",
        messagingSenderId: "282394062920",
        appId: "1:282394062920:web:3813e6f315262a0b33287d"
    };

    // åˆå§‹åŒ– Firebase èˆ‡ è³‡æ–™åº«
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const studentsRef = ref(db, 'students/');

    let currentUserId = localStorage.getItem('my_student_id'); // è®€å–ç€è¦½å™¨æš«å­˜ï¼Œå¯¦ç¾é é¢é‡æ–°æ•´ç†ä¸éºå¤±ç‹€æ…‹

    // --- åŠŸèƒ½ 1ï¼šåŠ å…¥æ•™å®¤ ---
    window.joinClass = async function() {
        const name = document.getElementById('student-name').value.trim();
        if (!name) return alert("è«‹è¼¸å…¥å§“åï¼");

        // æª¢æŸ¥äººæ•¸æ˜¯å¦å·²æ»¿ 20 äºº
        const snapshot = await get(studentsRef);
        const count = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
        
        if (count >= 20 && !currentUserId) {
            return alert("æ•™å®¤å·²æ»¿ 20 äººï¼Œç„¡æ³•åŠ å…¥ï¼");
        }

        // ä½¿ç”¨å§“åä½œç‚º ID ä¸¦å„²å­˜
        currentUserId = name;
        localStorage.setItem('my_student_id', currentUserId);
        
        // å¯«å…¥ Firebase
        update(ref(db, 'students/' + currentUserId), {
            name: name,
            status: 'æœªå¯„å‡º',
            lastActive: Date.now()
        });

        document.getElementById('login-section').style.display = 'none';
    };

    // --- åŠŸèƒ½ 2ï¼šæ›´æ–°ç‹€æ…‹ ---
    window.updateStatus = function(newStatus) {
        if (!currentUserId) return;
        update(ref(db, 'students/' + currentUserId), {
            status: newStatus
        });
    };

    // --- åŠŸèƒ½ 3ï¼šå³æ™‚ç›£è½è³‡æ–™è®Šå‹• (WebSocket) ---
    onValue(studentsRef, (snapshot) => {
        const data = snapshot.val();
        renderUI(data);
    });

    // --- åŠŸèƒ½ 4ï¼šæ¸²æŸ“ç•«é¢ ---
    function renderUI(students) {
        const grid = document.getElementById('student-grid');
        grid.innerHTML = '';
        
        if (!students) return;

        // è¨ˆç®—ç›®å‰äººæ•¸
        const studentList = Object.keys(students);
        document.getElementById('room-status').innerText = `ç›®å‰äººæ•¸ï¼š${studentList.length} / 20`;

        studentList.forEach(id => {
            const info = students[id];
            const isMe = (id === currentUserId);
            const isSent = (info.status === 'å·²å¯„å‡º');

            const card = document.createElement('div');
            card.className = `card ${isMe ? 'active' : ''}`;
            card.innerHTML = `
                <strong>${info.name} ${isMe ? '(æˆ‘)' : ''}</strong><br>
                <span class="status-tag ${isSent ? 'sent' : 'waiting'}">
                    ${info.status}
                </span>
                ${isMe ? `
                    <div style="margin-top:15px">
                        <button onclick="updateStatus('å·²å¯„å‡º')" class="btn btn-send">å·²å¯„å‡º</button>
                        <button onclick="updateStatus('å–æ¶ˆå¯„å‡º')" class="btn btn-cancel">å–æ¶ˆ</button>
                    </div>
                ` : ''}
            `;
            grid.appendChild(card);
        });

        // å¦‚æœå·²ç¶“ç™»å…¥éï¼Œéš±è—ç™»å…¥å€å¡Š
        if (currentUserId && students[currentUserId]) {
            document.getElementById('login-section').style.display = 'none';
        }
    }
</script>

</body>
</html>