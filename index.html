<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿæº–å‚™ç‹€æ…‹ç¢ºèªç³»çµ±</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; background-color: #f0f2f5; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; min-height: 400px; }
        h2 { text-align: center; color: #1a73e8; margin-top: 40px; }
        
        /* é€€å‡ºæŒ‰éˆ• */
        #reset-btn { position: absolute; top: 20px; right: 20px; background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; z-index: 100; font-weight: bold; }
        #reset-btn:hover { background: #5a6268; }

        /* ç™»å…¥å€å¡Š */
        .login-box { text-align: center; margin-bottom: 30px; padding: 20px; border: 2px dashed #ccc; border-radius: 8px; }
        input[type="text"] { padding: 10px; width: 200px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        
        /* ç‹€æ…‹å¡ç‰‡ç¶²æ ¼ */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .card { border: 1px solid #eee; padding: 15px; border-radius: 8px; text-align: center; background: #fff; transition: transform 0.2s; position: relative; }
        .card.active { border: 2px solid #1a73e8; box-shadow: 0 2px 8px rgba(26,115,232,0.2); background: #f8fbff; }
        
        .status-tag { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 14px; margin-top: 10px; }
        .sent { background: #e6f4ea; color: #1e8e3e; font-weight: bold; }
        .waiting { background: #fff3e0; color: #e65100; font-weight: bold; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { cursor: pointer; padding: 8px 16px; border: none; border-radius: 4px; font-weight: bold; margin: 5px; }
        .btn-send { background-color: #1e8e3e; color: white; }
        .btn-cancel { background-color: #d93025; color: white; } /* é€™è£¡ç¶­æŒç´…è‰²æé†’ */
        .btn-join { background-color: #1a73e8; color: white; }
    </style>
</head>
<body>

<div class="container">
    <button id="reset-btn" onclick="resetMe()" style="display: none;">é€€å‡º / æ›´æ›å§“å</button>
    
    <h2>ğŸ“ å­¸ç”Ÿæº–å‚™ç‹€æ…‹ç¢ºèªè¡¨</h2>

    <div id="login-section" class="login-box">
        <p>è«‹è¼¸å…¥æ‚¨çš„çµ„åˆ¥æˆ–å§“åä»¥åŠ å…¥ï¼š</p>
        <input type="text" id="student-name" placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€çµ„" maxlength="10">
        <button onclick="joinClass()" class="btn btn-join">é€²å…¥æ•™å®¤</button>
        <p id="room-status" style="font-size: 13px; color: #888; margin-top: 10px;"></p>
    </div>

    <div id="student-grid" class="grid"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAna6t9OKbPQ96tM6GMsIs0-pwvDOJraFc",
        authDomain: "student-check-system-39d00.firebaseapp.com",
        databaseURL: "https://student-check-system-39d00-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "student-check-system-39d00",
        storageBucket: "student-check-system-39d00.firebasestorage.app",
        messagingSenderId: "282394062920",
        appId: "1:282394062920:web:3813e6f315262a0b33287d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const studentsRef = ref(db, 'students/');

    let currentUserId = localStorage.getItem('my_student_id');

    window.joinClass = async function() {
        const name = document.getElementById('student-name').value.trim();
        if (!name) return alert("è«‹è¼¸å…¥å§“åï¼");

        const snapshot = await get(studentsRef);
        const count = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
        
        if (count >= 20 && !currentUserId) {
            return alert("æ•™å®¤å·²æ»¿ 20 äººï¼");
        }

        currentUserId = name;
        localStorage.setItem('my_student_id', currentUserId);
        
        update(ref(db, 'students/' + currentUserId), {
            name: name,
            status: 'å°šæœªå¯„å‡º'
        });
    };

    window.updateStatus = function(newStatus) {
        if (!currentUserId) return;
        update(ref(db, 'students/' + currentUserId), {
            status: newStatus
        });
    };

    window.resetMe = function() {
        if (!currentUserId) {
            localStorage.removeItem('my_student_id');
            location.reload();
            return;
        }

        if (confirm("ç¢ºå®šè¦åˆªé™¤æ­¤ç©å®¶ä¸¦é‡æ–°ç™»å…¥å—ï¼Ÿ")) {
            remove(ref(db, 'students/' + currentUserId)).then(() => {
                localStorage.removeItem('my_student_id');
                currentUserId = null;
                location.reload();
            }).catch(() => {
                localStorage.removeItem('my_student_id');
                location.reload();
            });
        }
    };

    onValue(studentsRef, (snapshot) => {
        const data = snapshot.val();
        renderUI(data);
    });

    function renderUI(students) {
        const grid = document.getElementById('student-grid');
        const loginSection = document.getElementById('login-section');
        const resetBtn = document.getElementById('reset-btn');
        grid.innerHTML = '';
        
        const count = students ? Object.keys(students).length : 0;
        document.getElementById('room-status').innerText = `ç›®å‰é€²åº¦ï¼š${count} / 20 çµ„`;

        if (currentUserId) {
            resetBtn.style.display = 'block';
            loginSection.style.display = 'none';
        } else {
            resetBtn.style.display = 'none';
            loginSection.style.display = 'block';
        }

        if (students) {
            Object.keys(students).forEach(id => {
                const info = students[id];
                const isMe = (id === currentUserId);
                const isSent = (info.status === 'å·²å¯„å‡º');

                const card = document.createElement('div');
                card.className = `card ${isMe ? 'active' : ''}`;
                card.innerHTML = `
                    <strong>${info.name} ${isMe ? '(æˆ‘)' : ''}</strong><br>
                    <span class="status-tag ${isSent ? 'sent' : 'waiting'}">
                        ${info.status}
                    </span>
                    ${isMe ? `
                        <div style="margin-top:10px">
                            <button onclick="updateStatus('å·²å¯„å‡º')" class="btn btn-send">å·²å¯„å‡º</button>
                            <button onclick="updateStatus('å°šæœªå¯„å‡º')" class="btn btn-cancel">å°šæœªå¯„å‡º</button>
                        </div>
                    ` : ''}
                `;
                grid.appendChild(card);
            });
        }
    }
</script>

</body>
</html>
